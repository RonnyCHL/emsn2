{
  "dashboard": {
    "title": "EMSN - Anomaly Detection",
    "tags": ["emsn", "anomalies", "monitoring"],
    "timezone": "browser",
    "schemaVersion": 16,
    "version": 1,
    "refresh": "1m",
    "panels": [
      {
        "id": 1,
        "title": "Active Anomalies",
        "type": "table",
        "gridPos": {"x": 0, "y": 0, "w": 24, "h": 8},
        "targets": [{
          "rawSql": "SELECT timestamp, anomaly_type, severity, station_id, description, metric_value, threshold_value, NOW() - timestamp as age FROM anomalies WHERE resolved_at IS NULL ORDER BY CASE severity WHEN 'critical' THEN 1 WHEN 'warning' THEN 2 ELSE 3 END, timestamp DESC LIMIT 50",
          "format": "table"
        }]
      },
      {
        "id": 2,
        "title": "Anomalies by Type (24h)",
        "type": "barchart",
        "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
        "targets": [{
          "rawSql": "SELECT anomaly_type, COUNT(*) as count FROM anomalies WHERE timestamp > NOW() - INTERVAL '24 hours' GROUP BY anomaly_type ORDER BY count DESC",
          "format": "table"
        }]
      },
      {
        "id": 3,
        "title": "Anomalies by Severity (24h)",
        "type": "piechart",
        "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
        "targets": [{
          "rawSql": "SELECT severity, COUNT(*) as count FROM anomalies WHERE timestamp > NOW() - INTERVAL '24 hours' GROUP BY severity",
          "format": "table"
        }]
      },
      {
        "id": 4,
        "title": "Anomalies Timeline (7 days)",
        "type": "timeseries",
        "gridPos": {"x": 0, "y": 16, "w": 24, "h": 8},
        "targets": [{
          "rawSql": "SELECT DATE_TRUNC('hour', timestamp) as time, anomaly_type, COUNT(*) as count FROM anomalies WHERE timestamp > NOW() - INTERVAL '7 days' GROUP BY time, anomaly_type ORDER BY time",
          "format": "time_series"
        }]
      },
      {
        "id": 5,
        "title": "Hardware Silence Events",
        "type": "stat",
        "gridPos": {"x": 0, "y": 24, "w": 6, "h": 4},
        "targets": [{
          "rawSql": "SELECT COUNT(*) FROM anomalies WHERE anomaly_type IN ('silence_daytime', 'silence_total') AND timestamp > NOW() - INTERVAL '24 hours'",
          "format": "table"
        }],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 1, "color": "yellow"},
                {"value": 5, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 6,
        "title": "Data Gap Events",
        "type": "stat",
        "gridPos": {"x": 6, "y": 24, "w": 6, "h": 4},
        "targets": [{
          "rawSql": "SELECT COUNT(*) FROM anomalies WHERE anomaly_type IN ('sync_lag', 'station_imbalance', 'database_growth_stalled') AND timestamp > NOW() - INTERVAL '24 hours'",
          "format": "table"
        }],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 1, "color": "yellow"},
                {"value": 3, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "id": 7,
        "title": "Check Performance",
        "type": "table",
        "gridPos": {"x": 12, "y": 24, "w": 12, "h": 4},
        "targets": [{
          "rawSql": "SELECT check_type, MAX(check_timestamp) as last_run, AVG(duration_ms) as avg_duration_ms, SUM(anomalies_found) as total_anomalies FROM anomaly_check_log WHERE check_timestamp > NOW() - INTERVAL '24 hours' GROUP BY check_type",
          "format": "table"
        }]
      },
      {
        "id": 8,
        "title": "Species Baselines",
        "type": "table",
        "gridPos": {"x": 0, "y": 28, "w": 24, "h": 8},
        "targets": [{
          "rawSql": "SELECT species_nl, detection_count, array_length(months_active, 1) as active_months, array_length(hours_active, 1) as active_hours, ROUND(avg_confidence::numeric, 2) as avg_conf, ROUND(avg_daily_count::numeric, 2) as daily_avg, last_updated FROM species_baselines ORDER BY detection_count DESC LIMIT 25",
          "format": "table"
        }]
      }
    ]
  },
  "overwrite": true
}
