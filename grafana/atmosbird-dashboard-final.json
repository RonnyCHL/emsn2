{
  "dashboard": {
    "title": "AtmosBird - Sky Monitoring",
    "tags": ["atmosbird", "sky", "astronomy"],
    "timezone": "browser",
    "schemaVersion": 38,
    "version": 3,
    "refresh": "5m",
    "panels": [
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 1,
        "title": "Latest Sky Capture",
        "type": "table",
        "gridPos": {"x": 0, "y": 0, "w": 24, "h": 4},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT observation_timestamp, sky_type, cloud_coverage as clouds_pct, ROUND(brightness::numeric, 1) as brightness, CONCAT('http://192.168.1.87:8090/atmosbird/', SUBSTRING(image_path FROM 19)) as photo_url FROM sky_observations ORDER BY observation_timestamp DESC LIMIT 1",
          "format": "table",
          "refId": "A"
        }],
        "options": {
          "showHeader": true
        },
        "fieldConfig": {
          "overrides": [{
            "matcher": {"id": "byName", "options": "photo_url"},
            "properties": [{
              "id": "links",
              "value": [{
                "title": "View Photo",
                "url": "${__value.raw}"
              }]
            }]
          }]
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 2,
        "title": "Total Sky Observations",
        "type": "stat",
        "gridPos": {"x": 0, "y": 4, "w": 6, "h": 3},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT COUNT(*) FROM sky_observations",
          "format": "table",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "thresholds"},
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "blue"},
                {"value": 100, "color": "green"},
                {"value": 1000, "color": "yellow"}
              ]
            }
          }
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 3,
        "title": "Observations Today",
        "type": "stat",
        "gridPos": {"x": 6, "y": 4, "w": 6, "h": 3},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT COUNT(*) FROM sky_observations WHERE observation_timestamp >= CURRENT_DATE",
          "format": "table",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "thresholds"},
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 50, "color": "yellow"},
                {"value": 100, "color": "green"}
              ]
            }
          }
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 4,
        "title": "Disk Usage",
        "type": "gauge",
        "gridPos": {"x": 12, "y": 4, "w": 6, "h": 3},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT ROUND(disk_usage_percent::numeric, 1) FROM atmosbird_health ORDER BY measurement_timestamp DESC LIMIT 1",
          "format": "table",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "min": 0,
            "max": 100,
            "unit": "percent",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 70, "color": "yellow"},
                {"value": 90, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 5,
        "title": "Photos Today",
        "type": "stat",
        "gridPos": {"x": 18, "y": 4, "w": 6, "h": 3},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT photos_captured_today FROM atmosbird_health ORDER BY measurement_timestamp DESC LIMIT 1",
          "format": "table",
          "refId": "A"
        }],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "palette-classic"}
          }
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 6,
        "title": "Cloud Coverage & Brightness (24h)",
        "type": "timeseries",
        "gridPos": {"x": 0, "y": 7, "w": 24, "h": 8},
        "targets": [
          {
            "datasource": {"type": "postgres", "uid": "emsn_postgres"},
            "rawSql": "SELECT observation_timestamp as time, cloud_coverage as value, 'Cloud Coverage %' as metric FROM sky_observations WHERE $__timeFilter(observation_timestamp) ORDER BY observation_timestamp",
            "format": "time_series",
            "refId": "A"
          },
          {
            "datasource": {"type": "postgres", "uid": "emsn_postgres"},
            "rawSql": "SELECT observation_timestamp as time, brightness::numeric as value, 'Brightness' as metric FROM sky_observations WHERE $__timeFilter(observation_timestamp) ORDER BY observation_timestamp",
            "format": "time_series",
            "refId": "B"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "lineWidth": 2,
              "fillOpacity": 10
            }
          },
          "overrides": [
            {
              "matcher": {"id": "byName", "options": "Cloud Coverage %"},
              "properties": [
                {"id": "color", "value": {"mode": "fixed", "fixedColor": "blue"}},
                {"id": "custom.axisPlacement", "value": "left"},
                {"id": "min", "value": 0},
                {"id": "max", "value": 100},
                {"id": "unit", "value": "percent"}
              ]
            },
            {
              "matcher": {"id": "byName", "options": "Brightness"},
              "properties": [
                {"id": "color", "value": {"mode": "fixed", "fixedColor": "yellow"}},
                {"id": "custom.axisPlacement", "value": "right"}
              ]
            }
          ]
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 7,
        "title": "Sky Type Distribution (24h)",
        "type": "piechart",
        "gridPos": {"x": 0, "y": 15, "w": 8, "h": 8},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT sky_type, COUNT(*) as count FROM sky_observations WHERE observation_timestamp > NOW() - INTERVAL '24 hours' GROUP BY sky_type",
          "format": "table",
          "refId": "A"
        }],
        "options": {
          "legend": {"displayMode": "list", "placement": "right"},
          "pieType": "pie",
          "reduceOptions": {"values": true, "calcs": ["lastNotNull"]},
          "tooltip": {"mode": "single"}
        }
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 8,
        "title": "Moon Phase Progress",
        "type": "table",
        "gridPos": {"x": 8, "y": 15, "w": 8, "h": 8},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT phase_name, ROUND(illumination_percent::numeric, 1) as illumination, age_days, TO_CHAR(observation_timestamp, 'YYYY-MM-DD HH24:MI') as time FROM moon_observations ORDER BY observation_timestamp DESC LIMIT 10",
          "format": "table",
          "refId": "A"
        }]
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 9,
        "title": "System Health",
        "type": "table",
        "gridPos": {"x": 16, "y": 15, "w": 8, "h": 8},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT TO_CHAR(measurement_timestamp, 'HH24:MI') as time, photos_captured_today as photos, ROUND(disk_usage_percent::numeric, 1) as disk_pct, CASE WHEN last_capture_success THEN '✓' ELSE '✗' END as status FROM atmosbird_health ORDER BY measurement_timestamp DESC LIMIT 10",
          "format": "table",
          "refId": "A"
        }]
      },
      {
        "datasource": {"type": "postgres", "uid": "emsn_postgres"},
        "id": 10,
        "title": "Recent Timelapses",
        "type": "table",
        "gridPos": {"x": 0, "y": 23, "w": 24, "h": 6},
        "targets": [{
          "datasource": {"type": "postgres", "uid": "emsn_postgres"},
          "rawSql": "SELECT created_timestamp, timelapse_type, frame_count, ROUND(duration_seconds::numeric, 1) as duration_sec, ROUND((file_size_bytes/1024/1024)::numeric, 2) as size_mb, CONCAT('http://192.168.1.87:8090/atmosbird/', SUBSTRING(video_path FROM 19)) as video_url FROM timelapses ORDER BY created_timestamp DESC LIMIT 10",
          "format": "table",
          "refId": "A"
        }],
        "fieldConfig": {
          "overrides": [{
            "matcher": {"id": "byName", "options": "video_url"},
            "properties": [{
              "id": "links",
              "value": [{
                "title": "Download Video",
                "url": "${__value.raw}"
              }]
            }]
          }]
        }
      }
    ],
    "time": {"from": "now-24h", "to": "now"},
    "timepicker": {}
  },
  "overwrite": true
}
